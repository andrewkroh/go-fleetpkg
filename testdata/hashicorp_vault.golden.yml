build:
  dependencies:
    ecs:
      reference: git@8.7
manifest:
  name: hashicorp_vault
  title: Hashicorp Vault
  version: 1.10.0
  release: ga
  description: Collect logs and metrics from Hashicorp Vault with Elastic Agent.
  type: integration
  icons:
    - src: /img/Vault_VerticalLogo_Color_RGB.svg
      title: Vault Logo
      size: 32x32
      type: image/svg+xml
  format_version: 1.0.0
  license: basic
  categories:
    - security
    - iam
  conditions:
    kibana:
      version: ^7.17.0 || ^8.0.0
  screenshots:
    - src: /img/hashicorp_vault-audit-dashboard.png
      title: Audit Log Dashboard
      size: 2742x2050
      type: image/png
    - src: /img/hashicorp_vault-log-dashboard.png
      title: Audit Log Dashboard
      size: 2752x1946
      type: image/png
  policy_templates:
    - name: hashicorp_vault
      title: Hashicorp Vault
      description: Collect logs and monitor Hashicorp Vault.
      inputs:
        - type: logfile
          title: Logs from file
          description: Collect Vault logs from file.
        - type: tcp
          title: Logs from TCP socket
          description: Collect Vault audit logs sent via TCP.
        - type: prometheus/metrics
          title: Metrics
          description: Collect Vault metrics via prometheus.
  owner:
    github: elastic/security-external-integrations
data_streams:
  audit:
    manifest:
      title: Hashicorp Vault Audit Logs
      type: logs
      streams:
        - input: logfile
          description: Collect Vault audit logs from file.
          title: Audit logs (file audit device)
          template_path: logfile.yml.hbs
          vars:
            - name: paths
              default:
                - /var/log/vault/audit*.json*
              type: text
              title: Paths
              multi: true
              show_user: true
            - name: preserve_original_event
              default: false
              description: Preserves a raw copy of the original event, added to the field `event.original`.
              type: bool
              title: Preserve original event
              multi: false
              required: true
              show_user: true
            - name: tags
              default:
                - hashicorp-vault-audit
              type: text
              title: Tags
              multi: true
              required: true
              show_user: false
            - name: processors
              description: |
                Processors are used to reduce the number of fields in the exported event or to enhance the event with metadata.  This executes in the agent before the logs are parsed. See [Processors](https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html) for details.
              type: yaml
              title: Processors
              multi: false
              required: false
              show_user: false
        - input: tcp
          description: Collect Vault audit logs from TCP socket.
          title: Audit logs (socket audit device)
          template_path: tcp.yml.hbs
          vars:
            - name: listen_address
              default: localhost
              description: The bind address to listen for TCP connections. Set to `0.0.0.0` to bind to all available interfaces.
              type: text
              title: Listen Address
              multi: false
              required: true
              show_user: true
            - name: listen_port
              default: 9007
              description: The TCP port number to listen on.
              type: integer
              title: Listen Port
              multi: false
              required: true
              show_user: true
            - name: preserve_original_event
              default: false
              description: Preserves a raw copy of the original event, added to the field `event.original`.
              type: bool
              title: Preserve original event
              multi: false
              required: true
              show_user: true
            - name: tags
              default:
                - hashicorp-vault-audit
                - forwarded
              type: text
              title: Tags
              multi: true
              required: true
              show_user: false
            - name: processors
              description: |
                Processors are used to reduce the number of fields in the exported event or to enhance the event with metadata.  This executes in the agent before the logs are parsed. See [Processors](https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html) for details.
              type: yaml
              title: Processors
              multi: false
              required: false
              show_user: false
          enabled: false
    pipelines:
      default.yml:
        description: Pipeline for processing Hashicorp Vault audit logs.
        processors:
          - set:
              field: ecs.version
              value: 8.7.0
          - rename:
              field: message
              ignore_failure: true
              ignore_missing: true
              target_field: event.original
          - json:
              field: event.original
              ignore_failure: true
              target_field: hashicorp_vault.audit
          - date:
              field: hashicorp_vault.audit.time
              formats:
                - ISO8601
          - remove:
              field:
                - hashicorp_vault.audit.time
              ignore_missing: true
          - set:
              field: event.kind
              value: event
          - append:
              field: event.category
              value: authentication
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.request?.operation == 'create'
              value: creation
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.request?.operation == 'delete'
              value: deletion
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.request?.operation == 'update'
              value: change
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.request?.operation == 'read' || ctx?.hashicorp_vault?.audit?.request?.operation == 'list'
              value: access
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.error != null
              value: error
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.error != null && ctx.hashicorp_vault.audit.error.contains("denied")
              value: denied
          - set:
              copy_from: hashicorp_vault.audit.request.operation
              field: event.action
          - set:
              field: event.outcome
              if: ctx?.hashicorp_vault?.audit?.error == null
              value: success
          - set:
              field: event.outcome
              if: ctx?.hashicorp_vault?.audit?.error != null
              value: failure
          - set:
              copy_from: hashicorp_vault.audit.request.id
              field: event.id
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.error
              field: message
              ignore_failure: true
          - convert:
              field: hashicorp_vault.audit.request.remote_address
              ignore_missing: true
              target_field: source.ip
              type: ip
          - convert:
              field: hashicorp_vault.audit.request.remote_port
              ignore_missing: true
              target_field: source.port
              type: long
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.email
              field: user.email
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.account_id
              field: user.id
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.AllocationID
              field: nomad.allocation.id
              if: |
                ctx?.hashicorp_vault?.audit?.auth?.metadata?.AllocationID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.NodeID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Namespace != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Task != null
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.Namespace
              field: nomad.namespace
              if: |
                ctx?.hashicorp_vault?.audit?.auth?.metadata?.AllocationID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.NodeID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Namespace != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Task != null
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.NodeID
              field: nomad.node.id
              if: |
                ctx?.hashicorp_vault?.audit?.auth?.metadata?.AllocationID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.NodeID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Namespace != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Task != null
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.Task
              field: nomad.task.name
              if: |
                ctx?.hashicorp_vault?.audit?.auth?.metadata?.AllocationID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.NodeID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Namespace != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Task != null
              ignore_failure: true
          - geoip:
              field: source.ip
              ignore_missing: true
              target_field: source.geo
          - geoip:
              database_file: GeoLite2-ASN.mmdb
              field: source.ip
              ignore_missing: true
              properties:
                - asn
                - organization_name
              target_field: source.as
          - rename:
              field: source.as.asn
              ignore_missing: true
              target_field: source.as.number
          - rename:
              field: source.as.organization_name
              ignore_missing: true
              target_field: source.as.organization.name
          - append:
              allow_duplicates: false
              field: related.ip
              if: ctx?.source?.ip != null
              value: '{{{source.ip}}}'
          - remove:
              field: event.original
              if: ctx?.tags == null || !(ctx.tags.contains('preserve_original_event'))
              ignore_failure: true
              ignore_missing: true
        on_failure:
          - set:
              field: error.message
              value: '{{ _ingest.on_failure_message }}'
  log:
    manifest:
      title: Hashicorp Vault Operational Logs
      type: logs
      streams:
        - input: logfile
          description: Collect Vault operational logs from file.
          title: Operation logs
          template_path: logfile.yml.hbs
          vars:
            - name: paths
              default:
                - /var/log/vault/log*.json*
              type: text
              title: Paths
              multi: true
              show_user: true
            - name: preserve_original_event
              default: false
              description: Preserves a raw copy of the original event, added to the field `event.original`.
              type: bool
              title: Preserve original event
              multi: false
              required: true
              show_user: true
            - name: tags
              default:
                - hashicorp-vault-log
              type: text
              title: Tags
              multi: true
              required: true
              show_user: false
            - name: processors
              description: |
                Processors are used to reduce the number of fields in the exported event or to enhance the event with metadata.  This executes in the agent before the logs are parsed. See [Processors](https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html) for details.
              type: yaml
              title: Processors
              multi: false
              required: false
              show_user: false
    pipelines:
      default.yml:
        description: Pipeline for processing Hashicorp Vault operational logs.
        processors:
          - set:
              field: ecs.version
              value: 8.7.0
          - set:
              field: event.kind
              value: event
          - rename:
              field: message
              ignore_failure: true
              target_field: event.original
          - pipeline:
              if: ctx?.event?.original != null && ctx.event.original.startsWith("{")
              name: '{{ IngestPipeline "json" }}'
          - set:
              copy_from: event.original
              field: message
              if: ctx?.event?.original != null && !ctx.event.original.startsWith("{")
              ignore_failure: true
          - remove:
              field: event.original
              if: ctx?.tags == null || !(ctx.tags.contains('preserve_original_event'))
              ignore_failure: true
              ignore_missing: true
        on_failure:
          - set:
              field: error.message
              value: '{{ _ingest.on_failure_message }}'
      json.yml:
        description: Pipeline for processing Hashicorp Vault operational logs in JSON format.
        processors:
          - json:
              field: event.original
              target_field: hashicorp_vault.log
          - date:
              field: hashicorp_vault.log.@timestamp
              formats:
                - ISO8601
          - remove:
              field:
                - hashicorp_vault.log.@timestamp
              ignore_missing: true
          - rename:
              field: hashicorp_vault.log.@level
              ignore_missing: true
              target_field: log.level
          - rename:
              field: hashicorp_vault.log.@message
              ignore_missing: true
              target_field: message
          - rename:
              field: hashicorp_vault.log.@module
              ignore_missing: true
              target_field: log.logger
          - script:
              description: Drop hashicorp_vault.log if empty.
              if: ctx?.hashicorp_vault?.log != null && ctx.hashicorp_vault.log.isEmpty()
              lang: painless
              source: |
                ctx.hashicorp_vault.remove("log");
                if (ctx.hashicorp_vault.isEmpty()) {
                  ctx.remove("hashicorp_vault");
                }
              tag: drop-empty-hashicorp_vault.log
          - set:
              copy_from: hashicorp_vault.log.file_path
              field: file.path
              ignore_failure: true
        on_failure:
          - set:
              field: error.message
              value: '{{ _ingest.on_failure_message }}'
  metrics:
    manifest:
      title: Hashicorp Vault Metrics
      type: metrics
      streams:
        - input: prometheus/metrics
          description: Collect prometheus metrics from Vault.
          title: Vault metrics (prometheus)
          template_path: metrics.yml.hbs
          vars:
            - name: period
              default: 30s
              type: text
              title: Period
            - name: hosts
              default:
                - http://localhost:8200
              description: Vault addresses to monitor. `/v1/sys/metrics?format=prometheus` is automatically appended.
              type: text
              title: Hosts
              multi: true
              required: true
              show_user: true
            - name: vault_token
              description: A Vault token with read access to the /sys/metrics API.
              type: text
              title: Vault Token
              multi: false
              required: true
              show_user: true
            - name: processors
              description: |
                Processors are used to reduce the number of fields in the exported event or to enhance the event with metadata. This executes in the agent before the logs are parsed. See [Processors](https://www.elastic.co/guide/en/beats/metricbeat/current/filtering-and-enhancing-data.html) for details.
              type: yaml
              title: Processors
              multi: false
              required: false
              show_user: false
            - name: ssl
              default: |-
                #certificate_authorities:
                #  - |
                #    -----BEGIN CERTIFICATE-----
                #    MIIDCjCCAfKgAwIBAgITJ706Mu2wJlKckpIvkWxEHvEyijANBgkqhkiG9w0BAQsF
                #    -----END CERTIFICATE-----
              description: i.e. certificate_authorities, supported_protocols, verification_mode etc.
              type: yaml
              title: SSL Configuration
              multi: false
              required: false
              show_user: false
      elasticsearch:
        index_template:
          mappings:
            dynamic: true
            dynamic_templates:
              - all_values:
                  mapping:
                    type: double
                  path_match: hashicorp_vault.metrics.*.value
              - all_counters:
                  mapping:
                    type: double
                  path_match: hashicorp_vault.metrics.*.counter
              - all_rates:
                  mapping:
                    type: double
                  path_match: hashicorp_vault.metrics.*.rate
              - all_histograms:
                  mapping:
                    type: histogram
                  path_match: hashicorp_vault.metrics.*.histogram
    pipelines:
      default.yml:
        description: Pipeline for processing Hashicorp Vault metrics.
        processors:
          - remove:
              field:
                - event.dataset
                - event.module
                - metricset.name
                - service.address
                - service.type
              ignore_missing: true
          - set:
              field: ecs.version
              value: 8.7.0
          - set:
              field: service.type
              value: hashicorp_vault
          - set:
              field: event.kind
              value: metric
          - rename:
              field: prometheus.labels
              ignore_missing: true
              target_field: labels
          - set:
              field: labels.job
              override: true
              value: hashicorp_vault
          - rename:
              field: prometheus
              ignore_missing: true
              target_field: hashicorp_vault.metrics
        on_failure:
          - set:
              field: error.message
              value: '{{ _ingest.on_failure_message }}'
