build:
  dependencies:
    ecs:
      reference: git@8.7
manifest:
  name: hashicorp_vault
  title: Hashicorp Vault
  version: 1.10.0
  release: ga
  description: Collect logs and metrics from Hashicorp Vault with Elastic Agent.
  type: integration
  icons:
    - src: /img/Vault_VerticalLogo_Color_RGB.svg
      title: Vault Logo
      size: 32x32
      type: image/svg+xml
  format_version: 1.0.0
  license: basic
  categories:
    - security
    - iam
  conditions:
    kibana:
      version: ^7.17.0 || ^8.0.0
  screenshots:
    - src: /img/hashicorp_vault-audit-dashboard.png
      title: Audit Log Dashboard
      size: 2742x2050
      type: image/png
    - src: /img/hashicorp_vault-log-dashboard.png
      title: Audit Log Dashboard
      size: 2752x1946
      type: image/png
  policy_templates:
    - name: hashicorp_vault
      title: Hashicorp Vault
      description: Collect logs and monitor Hashicorp Vault.
      inputs:
        - type: logfile
          title: Logs from file
          description: Collect Vault logs from file.
        - type: tcp
          title: Logs from TCP socket
          description: Collect Vault audit logs sent via TCP.
        - type: prometheus/metrics
          title: Metrics
          description: Collect Vault metrics via prometheus.
  owner:
    github: elastic/security-external-integrations
data_streams:
  audit:
    manifest:
      title: Hashicorp Vault Audit Logs
      type: logs
      streams:
        - input: logfile
          description: Collect Vault audit logs from file.
          title: Audit logs (file audit device)
          template_path: logfile.yml.hbs
          vars:
            - name: paths
              default:
                - /var/log/vault/audit*.json*
              type: text
              title: Paths
              multi: true
              show_user: true
            - name: preserve_original_event
              default: false
              description: Preserves a raw copy of the original event, added to the field `event.original`.
              type: bool
              title: Preserve original event
              multi: false
              required: true
              show_user: true
            - name: tags
              default:
                - hashicorp-vault-audit
              type: text
              title: Tags
              multi: true
              required: true
              show_user: false
            - name: processors
              description: |
                Processors are used to reduce the number of fields in the exported event or to enhance the event with metadata.  This executes in the agent before the logs are parsed. See [Processors](https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html) for details.
              type: yaml
              title: Processors
              multi: false
              required: false
              show_user: false
        - input: tcp
          description: Collect Vault audit logs from TCP socket.
          title: Audit logs (socket audit device)
          template_path: tcp.yml.hbs
          vars:
            - name: listen_address
              default: localhost
              description: The bind address to listen for TCP connections. Set to `0.0.0.0` to bind to all available interfaces.
              type: text
              title: Listen Address
              multi: false
              required: true
              show_user: true
            - name: listen_port
              default: 9007
              description: The TCP port number to listen on.
              type: integer
              title: Listen Port
              multi: false
              required: true
              show_user: true
            - name: preserve_original_event
              default: false
              description: Preserves a raw copy of the original event, added to the field `event.original`.
              type: bool
              title: Preserve original event
              multi: false
              required: true
              show_user: true
            - name: tags
              default:
                - hashicorp-vault-audit
                - forwarded
              type: text
              title: Tags
              multi: true
              required: true
              show_user: false
            - name: processors
              description: |
                Processors are used to reduce the number of fields in the exported event or to enhance the event with metadata.  This executes in the agent before the logs are parsed. See [Processors](https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html) for details.
              type: yaml
              title: Processors
              multi: false
              required: false
              show_user: false
          enabled: false
    pipelines:
      default.yml:
        description: Pipeline for processing Hashicorp Vault audit logs.
        processors:
          - set:
              field: ecs.version
              value: 8.7.0
          - rename:
              field: message
              ignore_failure: true
              ignore_missing: true
              target_field: event.original
          - json:
              field: event.original
              ignore_failure: true
              target_field: hashicorp_vault.audit
          - date:
              field: hashicorp_vault.audit.time
              formats:
                - ISO8601
          - remove:
              field:
                - hashicorp_vault.audit.time
              ignore_missing: true
          - set:
              field: event.kind
              value: event
          - append:
              field: event.category
              value: authentication
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.request?.operation == 'create'
              value: creation
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.request?.operation == 'delete'
              value: deletion
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.request?.operation == 'update'
              value: change
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.request?.operation == 'read' || ctx?.hashicorp_vault?.audit?.request?.operation == 'list'
              value: access
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.error != null
              value: error
          - append:
              field: event.type
              if: ctx?.hashicorp_vault?.audit?.error != null && ctx.hashicorp_vault.audit.error.contains("denied")
              value: denied
          - set:
              copy_from: hashicorp_vault.audit.request.operation
              field: event.action
          - set:
              field: event.outcome
              if: ctx?.hashicorp_vault?.audit?.error == null
              value: success
          - set:
              field: event.outcome
              if: ctx?.hashicorp_vault?.audit?.error != null
              value: failure
          - set:
              copy_from: hashicorp_vault.audit.request.id
              field: event.id
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.error
              field: message
              ignore_failure: true
          - convert:
              field: hashicorp_vault.audit.request.remote_address
              ignore_missing: true
              target_field: source.ip
              type: ip
          - convert:
              field: hashicorp_vault.audit.request.remote_port
              ignore_missing: true
              target_field: source.port
              type: long
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.email
              field: user.email
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.account_id
              field: user.id
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.AllocationID
              field: nomad.allocation.id
              if: |
                ctx?.hashicorp_vault?.audit?.auth?.metadata?.AllocationID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.NodeID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Namespace != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Task != null
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.Namespace
              field: nomad.namespace
              if: |
                ctx?.hashicorp_vault?.audit?.auth?.metadata?.AllocationID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.NodeID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Namespace != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Task != null
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.NodeID
              field: nomad.node.id
              if: |
                ctx?.hashicorp_vault?.audit?.auth?.metadata?.AllocationID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.NodeID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Namespace != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Task != null
              ignore_failure: true
          - set:
              copy_from: hashicorp_vault.audit.auth.metadata.Task
              field: nomad.task.name
              if: |
                ctx?.hashicorp_vault?.audit?.auth?.metadata?.AllocationID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.NodeID != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Namespace != null && ctx?.hashicorp_vault?.audit?.auth?.metadata?.Task != null
              ignore_failure: true
          - geoip:
              field: source.ip
              ignore_missing: true
              target_field: source.geo
          - geoip:
              database_file: GeoLite2-ASN.mmdb
              field: source.ip
              ignore_missing: true
              properties:
                - asn
                - organization_name
              target_field: source.as
          - rename:
              field: source.as.asn
              ignore_missing: true
              target_field: source.as.number
          - rename:
              field: source.as.organization_name
              ignore_missing: true
              target_field: source.as.organization.name
          - append:
              allow_duplicates: false
              field: related.ip
              if: ctx?.source?.ip != null
              value: '{{{source.ip}}}'
          - remove:
              field: event.original
              if: ctx?.tags == null || !(ctx.tags.contains('preserve_original_event'))
              ignore_failure: true
              ignore_missing: true
        on_failure:
          - set:
              field: error.message
              value: '{{ _ingest.on_failure_message }}'
    sample_event:
      event:
        '@timestamp': "2022-08-18T17:07:22.769Z"
        agent:
          ephemeral_id: 623671b3-bcc9-4060-9806-e1cb0b945aae
          id: 03109bfa-7015-46bd-9433-3879357210cd
          name: docker-fleet-agent
          type: filebeat
          version: 8.3.2
        data_stream:
          dataset: hashicorp_vault.audit
          namespace: ep
          type: logs
        ecs:
          version: 8.7.0
        elastic_agent:
          id: 03109bfa-7015-46bd-9433-3879357210cd
          snapshot: false
          version: 8.3.2
        event:
          action: update
          agent_id_status: verified
          category:
            - authentication
          dataset: hashicorp_vault.audit
          id: e54c706f-1a3d-9662-3705-872e05c9c39f
          ingested: "2022-08-18T17:07:55Z"
          kind: event
          original: '{"time":"2022-08-18T17:07:22.76907021Z","type":"request","auth":{"token_type":"default"},"request":{"id":"e54c706f-1a3d-9662-3705-872e05c9c39f","operation":"update","namespace":{"id":"root"},"path":"sys/audit/test"}}'
          outcome: success
          type:
            - change
        hashicorp_vault:
          audit:
            auth:
              token_type: default
            request:
              id: e54c706f-1a3d-9662-3705-872e05c9c39f
              namespace:
                id: root
              operation: update
              path: sys/audit/test
            type: request
        host:
          architecture: x86_64
          containerized: false
          hostname: docker-fleet-agent
          ip:
            - 172.23.0.7
          mac:
            - 02:42:ac:17:00:07
          name: docker-fleet-agent
          os:
            codename: focal
            family: debian
            kernel: 5.10.76-linuxkit
            name: Ubuntu
            platform: ubuntu
            type: linux
            version: 20.04.4 LTS (Focal Fossa)
        input:
          type: log
        log:
          file:
            path: /tmp/service_logs/vault/audit.json
          offset: 0
        tags:
          - preserve_original_event
          - hashicorp-vault-audit
    fields:
      agent.yml:
        fields:
          - name: input.type
            type: keyword
          - name: log.offset
            type: long
          - name: log.source.address
            type: keyword
            description: Source address (IP and port) of the log message.
      base-fields.yml:
        fields:
          - name: data_stream.type
            type: constant_keyword
            description: Data stream type.
          - name: data_stream.dataset
            type: constant_keyword
            description: Data stream dataset.
          - name: data_stream.namespace
            type: constant_keyword
            description: Data stream namespace.
          - name: '@timestamp'
            type: date
            description: Event timestamp.
          - name: event.module
            type: constant_keyword
            description: Event module
            value: hashicorp_vault
          - name: event.dataset
            type: constant_keyword
            description: Event dataset
            value: hashicorp_vault.audit
      ecs.yml:
        fields:
          - name: ecs.version
            external: ecs
          - name: event.action
            external: ecs
          - name: event.category
            external: ecs
          - name: event.id
            external: ecs
          - name: event.kind
            external: ecs
          - name: event.original
            external: ecs
          - name: event.outcome
            external: ecs
          - name: event.type
            external: ecs
          - name: message
            external: ecs
          - name: tags
            external: ecs
          - name: log.file.path
            external: ecs
          - name: related.ip
            external: ecs
          - name: source.as.number
            external: ecs
          - name: source.as.organization.name
            external: ecs
          - name: source.ip
            external: ecs
          - name: source.geo.city_name
            external: ecs
          - name: source.geo.continent_name
            external: ecs
          - name: source.geo.country_iso_code
            external: ecs
          - name: source.geo.country_name
            external: ecs
          - name: source.geo.location
            external: ecs
          - name: source.geo.region_iso_code
            external: ecs
          - name: source.geo.region_name
            external: ecs
          - name: source.port
            external: ecs
          - name: user.email
            external: ecs
          - name: user.id
            external: ecs
      fields.yml:
        fields:
          - name: hashicorp_vault
            type: group
            fields:
              - name: audit
                type: group
                fields:
                  - name: auth
                    type: group
                    fields:
                      - name: accessor
                        type: keyword
                        description: This is an HMAC of the client token accessor
                      - name: client_token
                        type: keyword
                        description: This is an HMAC of the client's token ID.
                      - name: display_name
                        type: keyword
                        description: |
                          Display name is a non-security sensitive identifier that is applicable to this auth. It is used for logging and prefixing of dynamic secrets. For example, it may be "armon" for the github credential backend. If the client token is used to generate a SQL credential, the user may be "github-armon-uuid". This is to help identify the source without using audit tables.
                      - name: entity_id
                        type: keyword
                        description: |
                          Entity ID is the identifier of the entity in identity store to which the identity of the authenticating client belongs to.
                      - name: external_namespace_policies
                        type: flattened
                        description: External namespace policies represent the policies authorized from different namespaces indexed by respective namespace identifiers.
                      - name: identity_policies
                        type: keyword
                        description: These are the policies sourced from the identity.
                      - name: metadata
                        type: flattened
                        description: This will contain a list of metadata key/value pairs associated with the authenticated user.
                      - name: no_default_policy
                        type: boolean
                        description: |
                          Indicates that the default policy should not be added by core when creating a token. The default policy will still be added if it's explicitly defined.
                      - name: policies
                        type: keyword
                        description: Policies is the list of policies that the authenticated user is associated with.
                      - name: policy_results.allowed
                        type: boolean
                      - name: policy_results.granting_policies
                        type: array
                        object_type: object
                      - name: policy_results.granting_policies.name
                        type: keyword
                      - name: policy_results.granting_policies.namespace_id
                        type: keyword
                      - name: policy_results.granting_policies.type
                        type: keyword
                      - name: remaining_uses
                        type: long
                      - name: token_issue_time
                        type: date
                      - name: token_policies
                        type: keyword
                        description: These are the policies sourced from the token.
                      - name: token_ttl
                        type: long
                      - name: token_type
                        type: keyword
                  - name: entity_created
                    type: boolean
                    description: entity_created is set to true if an entity is created as part of a login request.
                  - name: error
                    type: keyword
                    description: If an error occurred with the request, the error message is included in this field's value.
                  - name: request
                    type: group
                    fields:
                      - name: client_certificate_serial_number
                        type: keyword
                        description: Serial number from the client's certificate.
                      - name: client_id
                        type: keyword
                      - name: client_token
                        type: keyword
                        description: This is an HMAC of the client's token ID.
                      - name: client_token_accessor
                        type: keyword
                        description: This is an HMAC of the client token accessor.
                      - name: data
                        type: flattened
                        description: The data object will contain secret data in key/value pairs.
                      - name: headers
                        type: flattened
                        description: Additional HTTP headers specified by the client as part of the request.
                      - name: id
                        type: keyword
                        description: This is the unique request identifier.
                      - name: mount_accessor
                        type: keyword
                      - name: mount_type
                        type: keyword
                      - name: namespace.id
                        type: keyword
                      - name: namespace.path
                        type: keyword
                      - name: operation
                        type: keyword
                        description: |
                          This is the type of operation which corresponds to path capabilities and is expected to be one of: create, read, update, delete, or list.
                      - name: path
                        type: keyword
                        description: The requested Vault path for operation.
                        multi_fields:
                          - name: text
                            type: text
                      - name: policy_override
                        type: boolean
                        description: |
                          Policy override indicates that the requestor wishes to override soft-mandatory Sentinel policies.
                      - name: remote_address
                        type: ip
                        description: The IP address of the client making the request.
                      - name: remote_port
                        type: long
                        description: The remote port of the client making the request.
                      - name: replication_cluster
                        type: keyword
                        description: Name given to the replication secondary where this request originated.
                      - name: wrap_ttl
                        type: long
                        description: If the token is wrapped, this displays configured wrapped TTL in seconds.
                  - name: response
                    type: group
                    fields:
                      - name: auth
                        type: group
                        description: Authentication information for this response.
                        fields:
                          - name: accessor
                            type: keyword
                          - name: client_token
                            type: keyword
                          - name: display_name
                            type: keyword
                          - name: entity_id
                            type: keyword
                          - name: external_namespace_policies
                            type: flattened
                          - name: identity_policies
                            type: keyword
                          - name: metadata
                            type: flattened
                          - name: no_default_policy
                            type: boolean
                          - name: num_uses
                            type: long
                          - name: policies
                            type: keyword
                          - name: token_issue_time
                            type: date
                          - name: token_policies
                            type: keyword
                          - name: token_ttl
                            type: long
                            description: Time to live for the token in seconds.
                          - name: token_type
                            type: keyword
                      - name: data
                        type: flattened
                        description: Response payload.
                      - name: headers
                        type: flattened
                        description: |
                          Headers will contain the http headers from the plugin that it wishes to have as part of the output.
                      - name: mount_accessor
                        type: keyword
                      - name: mount_type
                        type: keyword
                      - name: redirect
                        type: keyword
                        description: |
                          Redirect is an HTTP URL to redirect to for further authentication. This is only valid for credential backends. This will be blanked for any logical backend and ignored.
                      - name: warnings
                        type: keyword
                      - name: wrap_info
                        type: group
                        description: Information for wrapping the response in a cubbyhole.
                        fields:
                          - name: accessor
                            type: keyword
                            description: The token accessor for the wrapped response token.
                          - name: creation_path
                            type: keyword
                            description: Creation path is the original request path that was used to create the wrapped response.
                          - name: creation_time
                            type: date
                            description: The creation time. This can be used with the TTL to figure out an expected expiration.
                          - name: token
                            type: keyword
                            description: The token containing the wrapped response.
                          - name: ttl
                            type: long
                            description: Specifies the desired TTL of the wrapping token.
                          - name: wrapped_accessor
                            type: keyword
                            description: The token accessor for the wrapped response token.
                  - name: type
                    type: keyword
                    description: Audit record type (request or response).
          - name: nomad.allocation.id
            type: keyword
            description: Nomad allocation ID
          - name: nomad.namespace
            type: keyword
            description: Nomad namespace.
          - name: nomad.node.id
            type: keyword
            description: Nomad node ID.
          - name: nomad.task.name
            type: keyword
            description: Nomad task name.
  log:
    manifest:
      title: Hashicorp Vault Operational Logs
      type: logs
      streams:
        - input: logfile
          description: Collect Vault operational logs from file.
          title: Operation logs
          template_path: logfile.yml.hbs
          vars:
            - name: paths
              default:
                - /var/log/vault/log*.json*
              type: text
              title: Paths
              multi: true
              show_user: true
            - name: preserve_original_event
              default: false
              description: Preserves a raw copy of the original event, added to the field `event.original`.
              type: bool
              title: Preserve original event
              multi: false
              required: true
              show_user: true
            - name: tags
              default:
                - hashicorp-vault-log
              type: text
              title: Tags
              multi: true
              required: true
              show_user: false
            - name: processors
              description: |
                Processors are used to reduce the number of fields in the exported event or to enhance the event with metadata.  This executes in the agent before the logs are parsed. See [Processors](https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html) for details.
              type: yaml
              title: Processors
              multi: false
              required: false
              show_user: false
    pipelines:
      default.yml:
        description: Pipeline for processing Hashicorp Vault operational logs.
        processors:
          - set:
              field: ecs.version
              value: 8.7.0
          - set:
              field: event.kind
              value: event
          - rename:
              field: message
              ignore_failure: true
              target_field: event.original
          - pipeline:
              if: ctx?.event?.original != null && ctx.event.original.startsWith("{")
              name: '{{ IngestPipeline "json" }}'
          - set:
              copy_from: event.original
              field: message
              if: ctx?.event?.original != null && !ctx.event.original.startsWith("{")
              ignore_failure: true
          - remove:
              field: event.original
              if: ctx?.tags == null || !(ctx.tags.contains('preserve_original_event'))
              ignore_failure: true
              ignore_missing: true
        on_failure:
          - set:
              field: error.message
              value: '{{ _ingest.on_failure_message }}'
      json.yml:
        description: Pipeline for processing Hashicorp Vault operational logs in JSON format.
        processors:
          - json:
              field: event.original
              target_field: hashicorp_vault.log
          - date:
              field: hashicorp_vault.log.@timestamp
              formats:
                - ISO8601
          - remove:
              field:
                - hashicorp_vault.log.@timestamp
              ignore_missing: true
          - rename:
              field: hashicorp_vault.log.@level
              ignore_missing: true
              target_field: log.level
          - rename:
              field: hashicorp_vault.log.@message
              ignore_missing: true
              target_field: message
          - rename:
              field: hashicorp_vault.log.@module
              ignore_missing: true
              target_field: log.logger
          - script:
              description: Drop hashicorp_vault.log if empty.
              if: ctx?.hashicorp_vault?.log != null && ctx.hashicorp_vault.log.isEmpty()
              lang: painless
              source: |
                ctx.hashicorp_vault.remove("log");
                if (ctx.hashicorp_vault.isEmpty()) {
                  ctx.remove("hashicorp_vault");
                }
              tag: drop-empty-hashicorp_vault.log
          - set:
              copy_from: hashicorp_vault.log.file_path
              field: file.path
              ignore_failure: true
        on_failure:
          - set:
              field: error.message
              value: '{{ _ingest.on_failure_message }}'
    sample_event:
      event:
        '@timestamp': "2022-01-13T01:56:49.423Z"
        agent:
          ephemeral_id: 519f95f7-ce93-4b23-b4ba-cb55bee8d69c
          id: 9878d192-22ad-49b6-a6c2-9959b0815d04
          name: docker-fleet-agent
          type: filebeat
          version: 8.0.0-beta1
        data_stream:
          dataset: hashicorp_vault.log
          namespace: ep
          type: logs
        ecs:
          version: 8.7.0
        elastic_agent:
          id: 9878d192-22ad-49b6-a6c2-9959b0815d04
          snapshot: false
          version: 8.0.0-beta1
        event:
          agent_id_status: verified
          dataset: hashicorp_vault.log
          ingested: "2022-01-13T01:57:16Z"
          kind: event
          original: '{"@level":"info","@message":"proxy environment","@timestamp":"2022-01-13T01:56:49.423084Z","http_proxy":"","https_proxy":"","no_proxy":""}'
        hashicorp_vault:
          log:
            http_proxy: ""
            https_proxy: ""
            no_proxy: ""
        host:
          architecture: x86_64
          containerized: true
          hostname: docker-fleet-agent
          id: 4ccba669f0df47fa3f57a9e4169ae7f1
          ip:
            - 172.18.0.4
          mac:
            - 02:42:ac:12:00:04
          name: docker-fleet-agent
          os:
            codename: Core
            family: redhat
            kernel: 5.11.0-44-generic
            name: CentOS Linux
            platform: centos
            type: linux
            version: 7 (Core)
        input:
          type: log
        log:
          file:
            path: /tmp/service_logs/log.json
          level: info
          offset: 679
        message: proxy environment
        tags:
          - preserve_original_event
          - hashicorp-vault-log
    fields:
      agent.yml:
        fields:
          - name: input.type
            type: keyword
          - name: log.offset
            type: long
      base-fields.yml:
        fields:
          - name: data_stream.type
            type: constant_keyword
            description: Data stream type.
          - name: data_stream.dataset
            type: constant_keyword
            description: Data stream dataset.
          - name: data_stream.namespace
            type: constant_keyword
            description: Data stream namespace.
          - name: '@timestamp'
            type: date
            description: Event timestamp.
          - name: event.module
            type: constant_keyword
            description: Event module
            value: hashicorp_vault
          - name: event.dataset
            type: constant_keyword
            description: Event dataset
            value: hashicorp_vault.log
      ecs.yml:
        fields:
          - name: ecs.version
            external: ecs
          - name: event.kind
            external: ecs
          - name: event.original
            external: ecs
          - name: message
            external: ecs
          - name: tags
            external: ecs
          - name: log.file.path
            external: ecs
          - name: log.level
            external: ecs
          - name: log.logger
            external: ecs
          - name: file.path
            external: ecs
      fields.yml:
        fields:
          - name: hashicorp_vault
            type: group
            fields:
              - name: log
                type: flattened
  metrics:
    manifest:
      title: Hashicorp Vault Metrics
      type: metrics
      streams:
        - input: prometheus/metrics
          description: Collect prometheus metrics from Vault.
          title: Vault metrics (prometheus)
          template_path: metrics.yml.hbs
          vars:
            - name: period
              default: 30s
              type: text
              title: Period
            - name: hosts
              default:
                - http://localhost:8200
              description: Vault addresses to monitor. `/v1/sys/metrics?format=prometheus` is automatically appended.
              type: text
              title: Hosts
              multi: true
              required: true
              show_user: true
            - name: vault_token
              description: A Vault token with read access to the /sys/metrics API.
              type: text
              title: Vault Token
              multi: false
              required: true
              show_user: true
            - name: processors
              description: |
                Processors are used to reduce the number of fields in the exported event or to enhance the event with metadata. This executes in the agent before the logs are parsed. See [Processors](https://www.elastic.co/guide/en/beats/metricbeat/current/filtering-and-enhancing-data.html) for details.
              type: yaml
              title: Processors
              multi: false
              required: false
              show_user: false
            - name: ssl
              default: |-
                #certificate_authorities:
                #  - |
                #    -----BEGIN CERTIFICATE-----
                #    MIIDCjCCAfKgAwIBAgITJ706Mu2wJlKckpIvkWxEHvEyijANBgkqhkiG9w0BAQsF
                #    -----END CERTIFICATE-----
              description: i.e. certificate_authorities, supported_protocols, verification_mode etc.
              type: yaml
              title: SSL Configuration
              multi: false
              required: false
              show_user: false
      elasticsearch:
        index_template:
          mappings:
            dynamic: true
            dynamic_templates:
              - all_values:
                  mapping:
                    type: double
                  path_match: hashicorp_vault.metrics.*.value
              - all_counters:
                  mapping:
                    type: double
                  path_match: hashicorp_vault.metrics.*.counter
              - all_rates:
                  mapping:
                    type: double
                  path_match: hashicorp_vault.metrics.*.rate
              - all_histograms:
                  mapping:
                    type: histogram
                  path_match: hashicorp_vault.metrics.*.histogram
    pipelines:
      default.yml:
        description: Pipeline for processing Hashicorp Vault metrics.
        processors:
          - remove:
              field:
                - event.dataset
                - event.module
                - metricset.name
                - service.address
                - service.type
              ignore_missing: true
          - set:
              field: ecs.version
              value: 8.7.0
          - set:
              field: service.type
              value: hashicorp_vault
          - set:
              field: event.kind
              value: metric
          - rename:
              field: prometheus.labels
              ignore_missing: true
              target_field: labels
          - set:
              field: labels.job
              override: true
              value: hashicorp_vault
          - rename:
              field: prometheus
              ignore_missing: true
              target_field: hashicorp_vault.metrics
        on_failure:
          - set:
              field: error.message
              value: '{{ _ingest.on_failure_message }}'
    sample_event:
      event:
        '@timestamp': "2022-01-13T01:58:13.388Z"
        agent:
          ephemeral_id: 6c9fb82b-59c7-43dd-b429-5d5a8f60f994
          id: 9878d192-22ad-49b6-a6c2-9959b0815d04
          name: docker-fleet-agent
          type: metricbeat
          version: 8.0.0-beta1
        data_stream:
          dataset: hashicorp_vault.metrics
          namespace: ep
          type: metrics
        ecs:
          version: 8.7.0
        elastic_agent:
          id: 9878d192-22ad-49b6-a6c2-9959b0815d04
          snapshot: false
          version: 8.0.0-beta1
        event:
          agent_id_status: verified
          duration: 2.522433e+06
          ingested: "2022-01-13T01:58:13Z"
          kind: metric
        hashicorp_vault:
          metrics:
            go_gc_duration_seconds_count:
              counter: 6
              rate: 0
            go_gc_duration_seconds_sum:
              counter: 0.000178341
              rate: 0
            go_goroutines:
              value: 235
            go_memstats_alloc_bytes:
              value: 1.2255384e+07
            go_memstats_alloc_bytes_total:
              counter: 3.4001072e+07
              rate: 0
            go_memstats_buck_hash_sys_bytes:
              value: 1.463139e+06
            go_memstats_frees_total:
              counter: 150857
              rate: 0
            go_memstats_gc_cpu_fraction:
              value: 0.0019060616740776953
            go_memstats_gc_sys_bytes:
              value: 5.881672e+06
            go_memstats_heap_alloc_bytes:
              value: 1.2255384e+07
            go_memstats_heap_idle_bytes:
              value: 5.0307072e+07
            go_memstats_heap_inuse_bytes:
              value: 1.552384e+07
            go_memstats_heap_objects:
              value: 47319
            go_memstats_heap_released_bytes:
              value: 4.4326912e+07
            go_memstats_heap_sys_bytes:
              value: 6.5830912e+07
            go_memstats_last_gc_time_seconds:
              value: 1.6420390905779526e+09
            go_memstats_lookups_total:
              counter: 0
              rate: 0
            go_memstats_mallocs_total:
              counter: 198176
              rate: 0
            go_memstats_mcache_inuse_bytes:
              value: 1200
            go_memstats_mcache_sys_bytes:
              value: 16384
            go_memstats_mspan_inuse_bytes:
              value: 175440
            go_memstats_mspan_sys_bytes:
              value: 196608
            go_memstats_next_gc_bytes:
              value: 2.4046448e+07
            go_memstats_other_sys_bytes:
              value: 389469
            go_memstats_stack_inuse_bytes:
              value: 1.277952e+06
            go_memstats_stack_sys_bytes:
              value: 1.277952e+06
            go_memstats_sys_bytes:
              value: 7.5056136e+07
            go_threads:
              value: 6
            process_cpu_seconds_total:
              counter: 0.12
              rate: 0
            process_max_fds:
              value: 1.048576e+06
            process_open_fds:
              value: 12
            process_resident_memory_bytes:
              value: 9.4257152e+07
            process_start_time_seconds:
              value: 1.6420390694e+09
            process_virtual_memory_bytes:
              value: 8.52996096e+08
            process_virtual_memory_max_bytes:
              value: -1
        host:
          architecture: x86_64
          containerized: true
          hostname: docker-fleet-agent
          id: 4ccba669f0df47fa3f57a9e4169ae7f1
          ip:
            - 172.18.0.4
          mac:
            - 02:42:ac:12:00:04
          name: docker-fleet-agent
          os:
            codename: Core
            family: redhat
            kernel: 5.11.0-44-generic
            name: CentOS Linux
            platform: centos
            type: linux
            version: 7 (Core)
        labels:
          instance: hashicorp_vault:8200
          job: hashicorp_vault
        metricset:
          period: 5000
        service:
          type: hashicorp_vault
    fields:
      base-fields.yml:
        fields:
          - name: data_stream.type
            type: constant_keyword
            description: Data stream type.
          - name: data_stream.dataset
            type: constant_keyword
            description: Data stream dataset.
          - name: data_stream.namespace
            type: constant_keyword
            description: Data stream namespace.
          - name: '@timestamp'
            type: date
            description: Event timestamp.
          - name: event.module
            type: constant_keyword
            description: Event module
            value: hashicorp_vault
          - name: event.dataset
            type: constant_keyword
            description: Event dataset
            value: hashicorp_vault.metrics
      ecs.yml:
        fields:
          - name: labels
            external: ecs
          - name: ecs.version
            external: ecs
          - name: event.duration
            external: ecs
          - name: event.kind
            external: ecs
          - name: service.type
            external: ecs
      fields.yml:
        fields:
          - name: hashicorp_vault.metrics.*.*
            description: Hashicorp Vault telemetry data from the Prometheus endpoint.
            dynamic: "true"
          - name: labels
            type: group
            fields:
              - name: auth_method
                type: keyword
                description: Authorization engine type.
              - name: cluster
                type: keyword
                description: |
                  The cluster name from which the metric originated; set in the configuration file, or automatically generated when a cluster is created.
              - name: creation_ttl
                type: keyword
                description: |
                  Time-to-live value assigned to a token or lease at creation. This value is rounded up to the next-highest bucket; the available buckets are 1m, 10m, 20m, 1h, 2h, 1d, 2d, 7d, and 30d. Any longer TTL is assigned the value +Inf.
              - name: host
                type: keyword
              - name: instance
                type: keyword
              - name: job
                type: keyword
              - name: local
                type: keyword
              - name: mount_point
                type: keyword
                description: Path at which an auth method or secret engine is mounted.
              - name: namespace
                type: keyword
                description: A namespace path, or root for the root namespace
              - name: quantile
                type: keyword
              - name: queue_id
                type: keyword
              - name: term
                type: keyword
              - name: token_type
                type: keyword
                description: Identifies whether the token is a batch token or a service token.
                example: service
              - name: type
                type: keyword
              - name: version
                type: keyword
changelog:
  releases:
    - version: 1.10.0
      changes:
        - description: Update package to ECS 8.7.0.
          type: enhancement
          link: https://github.com/elastic/integrations/pull/5765
    - version: 1.9.1
      changes:
        - description: Added categories and/or subcategories.
          type: enhancement
          link: https://github.com/elastic/integrations/pull/5123
    - version: 1.9.0
      changes:
        - description: Update package to ECS 8.6.0.
          type: enhancement
          link: https://github.com/elastic/integrations/pull/4576
    - version: 1.8.0
      changes:
        - description: Update package to ECS 8.5.0.
          type: enhancement
          link: https://github.com/elastic/integrations/pull/4285
    - version: 1.7.0
      changes:
        - description: Update mappings for Hashicorp Vault 1.11.
          type: enhancement
          link: https://github.com/elastic/integrations/pull/4036
    - version: 1.6.0
      changes:
        - description: Update package to ECS 8.4.0
          type: enhancement
          link: https://github.com/elastic/integrations/pull/3865
    - version: 1.5.0
      changes:
        - description: Update package to ECS 8.3.0.
          type: enhancement
          link: https://github.com/elastic/integrations/pull/3353
    - version: 1.4.0
      changes:
        - description: Update to ECS 8.2
          type: enhancement
          link: https://github.com/elastic/integrations/pull/2779
    - version: 1.3.3
      changes:
        - description: Use dynamic mappings for all hashicorp_vault.metrics fields.
          type: bugfix
          link: https://github.com/elastic/integrations/pull/2994
    - version: 1.3.2
      changes:
        - description: Add documentation for multi-fields
          type: enhancement
          link: https://github.com/elastic/integrations/pull/2916
    - version: 1.3.1
      changes:
        - description: Update docs to use markdown code blocks
          type: enhancement
          link: https://github.com/elastic/integrations/pull/2655
    - version: 1.3.0
      changes:
        - description: Update to ECS 8.0
          type: enhancement
          link: https://github.com/elastic/integrations/pull/2409
    - version: 1.2.3
      changes:
        - description: Make hashicorp_vault.audit.request.id optional in the audit pipeline to prevent errors.
          type: bugfix
          link: https://github.com/elastic/integrations/pull/2471
    - version: 1.2.2
      changes:
        - description: Regenerate test files using the new GeoIP database
          type: bugfix
          link: https://github.com/elastic/integrations/pull/2339
    - version: 1.2.1
      changes:
        - description: Change test public IPs to the supported subset
          type: bugfix
          link: https://github.com/elastic/integrations/pull/2327
    - version: 1.2.0
      changes:
        - description: Add 8.0.0 version constraint
          type: enhancement
          link: https://github.com/elastic/integrations/pull/2238
    - version: 1.1.4
      changes:
        - description: Uniform with guidelines
          type: enhancement
          link: https://github.com/elastic/integrations/pull/2105
    - version: 1.1.3
      changes:
        - description: Update Title and Description.
          type: enhancement
          link: https://github.com/elastic/integrations/pull/1967
    - version: 1.1.2
      changes:
        - description: Add missing fields to metrics
          type: enhancement
          link: https://github.com/elastic/integrations/pull/1889
    - version: 1.1.1
      changes:
        - description: Fix logic that checks for the 'forwarded' tag
          type: bugfix
          link: https://github.com/elastic/integrations/pull/1821
    - version: 1.1.0
      changes:
        - description: Update to ECS 1.12.0
          type: enhancement
          link: https://github.com/elastic/integrations/pull/1662
    - version: 1.0.0
      changes:
        - description: make GA
          type: enhancement
          link: https://github.com/elastic/integrations/pull/1735
    - version: 0.0.1
      changes:
        - description: Initial package with audit, log, and metrics.
          type: enhancement
          link: https://github.com/elastic/integrations/pull/1346
